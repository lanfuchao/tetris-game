# 难度系统说明

## 概述

游戏现在支持三种难度模式：简单、普通、困难。每种难度使用不同的速度曲线和计分系统。

## 难度模式对比

| 难度 | 初始速度 | 最低速度 | 分数倍率 | 升级门槛 | 适合人群 |
|------|---------|---------|---------|---------|---------|
| 简单 | 1000ms | 200ms | 1.0x | 1200分/级 | 新手玩家 |
| 普通 | 800ms | 120ms | 1.5x | 1000分/级 | 普通玩家 |
| 困难 | 600ms | 80ms | 2.0x | 800分/级 | 高手玩家 |

## 速度算法

### 旧算法 (线性递减)
```
speed = max(100, 1000 - (level - 1) * 100)
```

**问题：**
- 线性递减导致前期变化缓慢
- 后期突然变得极快
- 不够平滑，体验不佳

### 新算法 (指数衰减)

采用指数衰减曲线，更符合人类学习曲线：

#### 简单模式
```typescript
speed = 1000 * 0.92^(level - 1)
最低: 200ms
```

#### 普通模式
```typescript
speed = 800 * 0.88^(level - 1)
最低: 120ms
```

#### 困难模式
```typescript
speed = 600 * 0.85^(level - 1)
最低: 80ms
```

**优势：**
- 前期下降适中，给玩家适应时间
- 中期保持挑战性
- 后期趋于稳定，避免过度困难
- 更平滑的难度曲线

## 速度对比表

### 简单模式速度曲线
| 等级 | 速度(ms) | 每秒方块数 |
|------|---------|-----------|
| 1 | 1000 | 1.00 |
| 2 | 920 | 1.09 |
| 3 | 846 | 1.18 |
| 5 | 716 | 1.40 |
| 10 | 434 | 2.30 |
| 15 | 263 | 3.80 |
| 20+ | 200 | 5.00 |

### 普通模式速度曲线
| 等级 | 速度(ms) | 每秒方块数 |
|------|---------|-----------|
| 1 | 800 | 1.25 |
| 2 | 704 | 1.42 |
| 3 | 620 | 1.61 |
| 5 | 479 | 2.09 |
| 10 | 237 | 4.22 |
| 15 | 117 | 8.55 |
| 18+ | 120 | 8.33 |

### 困难模式速度曲线
| 等级 | 速度(ms) | 每秒方块数 |
|------|---------|-----------|
| 1 | 600 | 1.67 |
| 2 | 510 | 1.96 |
| 3 | 434 | 2.30 |
| 5 | 313 | 3.19 |
| 10 | 118 | 8.47 |
| 13+ | 80 | 12.50 |

## 计分系统

### 基础分数
- 消除1行: 100分
- 消除2行: 300分
- 消除3行: 500分
- 消除4行: 800分

### 实际得分计算
```typescript
实际得分 = 基础分数 × 当前等级 × 难度倍率
```

### 示例计算

**简单模式，等级5，消除2行：**
```
得分 = 300 × 5 × 1.0 = 1500分
```

**普通模式，等级5，消除2行：**
```
得分 = 300 × 5 × 1.5 = 2250分
```

**困难模式，等级5，消除2行：**
```
得分 = 300 × 5 × 2.0 = 3000分
```

## 升级系统

### 等级计算
```typescript
等级 = Math.floor(总分数 / 升级门槛) + 1
```

### 升级示例

**简单模式 (1200分/级):**
- 0-1199分: 等级1
- 1200-2399分: 等级2
- 2400-3599分: 等级3

**普通模式 (1000分/级):**
- 0-999分: 等级1
- 1000-1999分: 等级2
- 2000-2999分: 等级3

**困难模式 (800分/级):**
- 0-799分: 等级1
- 800-1599分: 等级2
- 1600-2399分: 等级3

## 游戏体验设计

### 简单模式
- **目标玩家**: 从未玩过俄罗斯方块的新手
- **设计理念**: 给足够时间思考和操作
- **速度递增**: 非常缓慢，到20级才达到最快速度
- **分数获取**: 标准分数，鼓励玩家尝试消除多行

### 普通模式
- **目标玩家**: 有一定游戏经验的玩家
- **设计理念**: 平衡挑战性和可玩性
- **速度递增**: 适中，15级左右达到最快速度
- **分数获取**: 1.5倍加成，鼓励追求高分

### 困难模式
- **目标玩家**: 俄罗斯方块高手
- **设计理念**: 极限挑战，考验反应速度
- **速度递增**: 快速，10级左右就已经非常快
- **分数获取**: 2倍加成，高风险高回报

## 技术实现

### 文件结构
```
src/
├── difficulty.ts       # 难度配置和计算函数
├── types.ts           # 难度枚举和接口定义
└── game.ts            # 游戏逻辑集成
```

### 核心函数

#### getSpeed()
```typescript
// 获取指定难度和等级的下落速度
function getSpeed(difficulty: Difficulty, level: number): number
```

#### calculateLevel()
```typescript
// 根据分数计算当前等级
function calculateLevel(difficulty: Difficulty, score: number): number
```

#### getDifficultyConfig()
```typescript
// 获取难度配置信息
function getDifficultyConfig(difficulty: Difficulty): DifficultyConfig
```

## 数学原理

### 指数衰减公式
```
y = a × b^(x-1)
```

其中：
- `a` = 初始速度
- `b` = 衰减率 (0 < b < 1)
- `x` = 等级
- `y` = 当前速度

### 衰减率选择

| 难度 | 衰减率 | 说明 |
|------|-------|------|
| 简单 | 0.92 | 每级减少8%，变化缓慢 |
| 普通 | 0.88 | 每级减少12%，适中 |
| 困难 | 0.85 | 每级减少15%，变化快速 |

### 可视化对比

```
速度 (ms)
1000 |●                                简单
 900 | ●
 800 |  ◆                             普通
 700 |  ●◆
 600 |   ■                            困难
 500 |   ●◆■
 400 |    ●◆■
 300 |     ●◆■
 200 |-------●----------------------- 简单最低
 100 |        ◆---------------------- 普通最低
  80 |         ■--------------------- 困难最低
     +--------------------------------
     1   5   10   15   20   25   等级
```

## 调优建议

### 如果觉得太难
1. 增大衰减率 (如: 0.92 → 0.94)
2. 提高最低速度限制
3. 降低升级门槛

### 如果觉得太简单
1. 减小衰减率 (如: 0.88 → 0.85)
2. 降低最低速度限制
3. 提高升级门槛

### 修改方法

编辑 `src/difficulty.ts`:

```typescript
[Difficulty.NORMAL]: {
    initialSpeed: 800,           // 调整初始速度
    speedCurve: (level: number) => {
        const speed = 800 * Math.pow(0.88, level - 1);  // 调整衰减率
        return Math.max(120, Math.round(speed));        // 调整最低速度
    },
    scoreMultiplier: 1.5,        // 调整分数倍率
    levelUpThreshold: 1000       // 调整升级门槛
}
```

## 未来扩展

可以考虑添加的功能：
1. **自定义难度**: 让玩家自定义各项参数
2. **渐进难度**: 随着时间推移自动增加难度
3. **挑战模式**: 特殊规则的限时挑战
4. **马拉松模式**: 固定目标（如40行）的计时模式
5. **排行榜**: 分难度记录最高分

## 参考资料

- [游戏难度设计理论](https://en.wikipedia.org/wiki/Game_balance)
- [指数函数在游戏设计中的应用](https://www.gamasutra.com/view/feature/134768/the_chemistry_of_game_design.php)
- [经典俄罗斯方块速度表](https://tetris.wiki/Tetris_(NES,_Nintendo))
